// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  USER
  ADMIN
  SUPER_ADMIN
}

// ============================================
// MODELS
// ============================================

/// Organization model for multi-tenancy support
model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  users         User[]
  refreshTokens RefreshToken[]

  @@map("organizations")
}

/// User model with role-based access control and Clerk auth support
model User {
  id              String   @id @default(uuid())
  email           String   @unique
  password        String?  // Nullable for OAuth users
  firstName       String?  @map("first_name")
  lastName        String?  @map("last_name")
  avatarUrl       String?  @map("avatar_url")
  role            Role     @default(USER)
  isActive        Boolean  @default(true) @map("is_active")
  emailVerified   Boolean  @default(false) @map("email_verified")

  // Clerk Auth
  clerkId         String?  @unique @map("clerk_id")

  // App-specific settings
  timezone            String   @default("UTC")
  dayCutoffHour       Int      @default(3) @map("day_cutoff_hour") // Hour of day when day resets (0-6)
  dayCloseReminderHour Int?    @map("day_close_reminder_hour") // Hour for day close reminder (0-23)
  fcmToken            String?  @map("fcm_token") // Firebase Cloud Messaging token

  // Gamification
  currentStreak   Int      @default(0) @map("current_streak")
  bestStreak      Int      @default(0) @map("best_streak")
  lastActiveDate  DateTime? @map("last_active_date")
  lastSyncAt      DateTime? @map("last_sync_at") // For offline sync

  // Multi-tenancy
  organizationId  String?  @map("organization_id")
  organization    Organization? @relation(fields: [organizationId], references: [id])

  // Audit fields
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  deletedAt       DateTime? @map("deleted_at")
  createdBy       String?  @map("created_by")
  updatedBy       String?  @map("updated_by")

  // Relations
  refreshTokens   RefreshToken[]
  blocks          Block[]
  tasks           Task[]

  @@index([email])
  @@index([clerkId])
  @@index([organizationId])
  @@map("users")
}

/// Refresh tokens for JWT authentication
model RefreshToken {
  id             String   @id @default(uuid())
  token          String   @unique
  userId         String   @map("user_id")
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Multi-tenancy
  organizationId String?  @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  expiresAt      DateTime @map("expires_at")
  createdAt      DateTime @default(now()) @map("created_at")
  revokedAt      DateTime? @map("revoked_at")

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

/// Block model - Container for daily loops/tasks
model Block {
  id          String   @id @default(uuid())
  name        String
  description String?
  icon        String?  // Emoji or icon name
  color       String?  // Hex color code
  sortOrder   Int      @default(0) @map("sort_order")
  isArchived  Boolean  @default(false) @map("is_archived")

  // Active days for weekly schedule (0=Sun, 1=Mon, ..., 6=Sat)
  // Block only shows on these days unless it has tasks
  activeDays  Int[]    @default([0,1,2,3,4,5,6]) @map("active_days")

  // Reminder settings
  reminderEnabled Boolean @default(false) @map("reminder_enabled")
  reminderHour    Int?    @map("reminder_hour") // Hour of day for reminder (0-23)

  // User relationship (DailyLoop is personal, no org)
  userId      String   @map("user_id")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Audit fields
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  createdBy   String?  @map("created_by")
  updatedBy   String?  @map("updated_by")

  // Relations
  tasks       Task[]

  @@index([userId])
  @@index([deletedAt])
  @@map("blocks")
}

/// Task model - Individual daily loop items
model Task {
  id          String    @id @default(uuid())
  title       String
  description String?
  emoji       String?   // Visual indicator
  sortOrder   Int       @default(0) @map("sort_order")
  isArchived  Boolean   @default(false) @map("is_archived")

  // Task type: true = one-off, false = loop/recurring
  isOneOff    Boolean   @default(false) @map("is_one_off")

  // One-off specific
  dueDate     DateTime? @db.Date @map("due_date")

  // Loop specific
  frequency   Frequency @default(DAILY) @map("frequency")
  daysOfWeek  Int[]     @default([1,2,3,4,5,6,0]) @map("days_of_week") // 0=Sun, 1=Mon, etc.
  skipDays    Int       @default(0) @map("skip_days") // Skip N days after completion
  resetDays   Int       @default(0) @map("reset_days") // Reset N days after last completion

  // User relationship
  userId      String    @map("user_id")
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Block relationship
  blockId     String?   @map("block_id")
  block       Block?    @relation(fields: [blockId], references: [id], onDelete: SetNull)

  // Audit fields
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  deletedAt   DateTime? @map("deleted_at")
  createdBy   String?   @map("created_by")
  updatedBy   String?   @map("updated_by")

  // Relations
  instances   TaskInstance[]

  @@index([userId])
  @@index([blockId])
  @@index([deletedAt])
  @@map("tasks")
}

/// Task instance - Actual task occurrence for a specific day
model TaskInstance {
  id          String           @id @default(uuid())
  date        DateTime         @db.Date // The date this instance is for
  status      InstanceStatus   @default(PENDING) @map("status")
  notes       String?
  completedAt DateTime?        @map("completed_at")

  // Task relationship
  taskId      String           @map("task_id")
  task        Task             @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Audit fields
  createdAt   DateTime         @default(now()) @map("created_at")
  updatedAt   DateTime         @updatedAt @map("updated_at")

  @@unique([taskId, date]) // One instance per task per day
  @@index([taskId])
  @@index([date])
  @@map("task_instances")
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
  CUSTOM
}

enum InstanceStatus {
  PENDING
  COMPLETED
  SKIPPED
  MISSED
}

/// Sync log for tracking changes for offline sync
model SyncLog {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  entity    String   // 'block', 'task', 'task-instance'
  entityId  String   @map("entity_id")
  action    String   // 'create', 'update', 'delete'
  timestamp DateTime @default(now()) @map("timestamp")
  data      String?  // JSON data for conflict resolution

  @@index([userId, timestamp])
  @@map("sync_logs")
}
